import { createRouter, createWebHistory } from 'vue-router';
import ViewHome from '../views/HomeLayout/ViewHome.vue'
import ViewLogin from "@/views/AuthLayout/ViewLogin.vue";
import store from "../store";
import {useToast} from "vue-toastification";


const toast = useToast()
const routes = [
  {
    path: '/',
    name: 'Home',
    component: ViewHome,
    meta: { layout: 'home', auth: false, roles: ['all'] }
  },
  {
    path: '/dashboard',
    name: 'Dashboard',
    component: ()=> import('../views/MainLayout/ViewDashboard.vue'),
    meta: { layout: 'main', auth: true, roles: ['admin', 'director', 'manager'] }
  },
  {
    path: '/login',
    name: 'Login',
    component: ViewLogin,
    meta: { layout: 'home', auth: false, roles: ['all'] }
  },
  {
    path: '/courses',
    name: 'Courses',
    component: ()=> import('../views/MainLayout/Courses/ViewCourse.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager', 'teacher', 'Administrator']
    }
  },
  {
    path: '/roles',
    name: 'Roles',
    component: ()=> import('../views/MainLayout/Roles/ViewRole.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager']
    }
  },
  {
    path: '/rooms',
    name: 'Rooms',
    component: ()=> import('../views/MainLayout/Rooms/ViewRoom.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager', 'administrator']
    }
  },
  {
    path: '/users',
    name: 'Users',
    component: ()=> import('../views/MainLayout/Users/ViewUser.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager']
    }
  },
  {
    path: '/students',
    name: 'Students',
    component: ()=> import('@/views/MainLayout/Students/ViewStudents.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager','reception','teacher', 'administrator']
    }
  },
  {
    path: '/groups',
    name: 'Groups',
    component: ()=> import('../views/MainLayout/Groups/ViewGroup.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager', 'teacher', 'reception', 'administrator']
    }
  },
  {
    path: '/payments',
    name: 'Payments',
    component: ()=> import('../views/MainLayout/Payments/ViewPayments.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager', 'administrator']
    }
  },
  {
    path: '/tasks',
    name: 'Tasks',
    component: ()=> import('../views/MainLayout/Tasks/ViewTasks.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager', 'administrator']
    }
  },
  {
    path: '/discounts',
    name: 'Discounts',
    component: ()=> import('../views/MainLayout/Discounts/ViewDiscounts.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager', 'administrator']
    }
  },
  {
    path: '/companies',
    name: 'Company',
    component: () => import('../views/MainLayout/Companies/ViewCompany.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager']
    }
  },
  {
    path: '/branches',
    name: 'Branch',
    component: () => import('../views/MainLayout/Branches/ViewBranches.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager']
    }
  },

  {
    path: '/tenants',
    name: 'Tenants',
    component: () => import('../views/MainLayout/Tenants/ViewTenants.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager']
    }
  },

  {
    path: '/permissions',
    name: 'Permissions',
    component: () => import('../views/MainLayout/Permissions/ViewPermissions.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager']
    }
  },

  {
    path: '/notifications',
    name: 'Notifications',
    component: () => import('../views/MainLayout/Notifications/ViewNotifications.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager']
    }
  },


  {
    path: '/watchcourse/:id?',
    name: 'WatchCourse',
    component: ()=> import('../views/MainLayout/Courses/ViewRequestCourse.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager', 'administrator']
    }
  },
  {
    path: '/watchroom/:id?',
    name: 'WatchRoom',
    component: ()=> import('../views/MainLayout/Rooms/ViewRequestRoom.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager', 'administrator']
    }
  },
  {
    path: '/watchUser/:id?',
    name: 'WatchUser',
    component: ()=> import('../views/MainLayout/Users/ViewRequestUser.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager']
    }
  },
  {
    path: '/watchStudent/:id?',
    name: 'WatchStudent',
    component: () => import('../views/MainLayout/Students/ViewRequestStudent.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager', 'administrator']
    }
  },
  {
     path: '/watchGroup/:id?',
     name: 'WatchGroup',
     component: ()=> import('../views/MainLayout/Groups/ViewRequestGroup.vue'),
     meta: {
       layout: 'main',
       auth: true,
       roles: ['admin', 'director', 'manager', 'administrator']
     }
  },
  {
    path: '/watchPayment/:id?',
    name: 'WatchPayment',
    component: ()=> import('../views/MainLayout/Payments/ViewRequestPayments.vue'),
    meta: {
      layout: 'main',
      roles: ['admin', 'director', 'manager', 'administrator']
    }
  },
  {
    path: '/watchTask/:id?',
    name: 'WatchTask',
    component: ()=> import('../views/MainLayout/Tasks/ViewRequestTask.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager']
    }
  },
  {
    path: '/watchDiscount/:id?',
    name: 'WatchDiscount',
    component: ()=> import('../views/MainLayout/Discounts/ViewRequestDiscount.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager', 'administrator']
    }
  },
  {
    path: '/watchCompany/:id?',
    name: 'WatchCompany',
    component: () => import('../views/MainLayout/Companies/ViewRequestCompany.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager']
    }
  },

  {
    path: '/watchBranch/:id?',
    name: 'WatchBranch',
    component: () => import('../views/MainLayout/Branches/ViewRequestBranch.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager']
    }
  },

  {
    path: '/watchTenant/:id?',
    name: 'watchTenant',
    component: () => import('../views/MainLayout/Tenants/ViewRequestTenants.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager']
    }
  },

  {
    path: '/watchPermission/:id?',
    name: 'watchPermission',
    component: () => import('../views/MainLayout/Permissions/ViewRequestPermission.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager']
    }
  },

  {
    path: '/watchNotification/:id?',
    name: 'watchNotification',
    component: () => import('../views/MainLayout/Notifications/ViewRequestNotification.vue'),
    meta: {
      layout: 'main',
      auth: true,
      roles: ['admin', 'director', 'manager']
    }
  },



  {
    path: '/:pathMatch(.*)*',
    name: 'NotFound',
    component: () => import('@/views/NotFound.vue'),
    meta:{
      layout: 'main',
      auth: true,
      roles: ['all']
    }
  },

  {
    path: '/profile',
    name: 'Profile',
    component: ()=> import('../views/MainLayout/Profile/ViewProfile.vue'),
    meta: { layout: 'main', auth: false, roles: ['all'] }
  }

];

const router = createRouter({
  history: createWebHistory(),
  routes,
  linkActiveClass:'bg-gray-700',
  linkExactActiveClass:'bg-gray-700',
});
router.beforeEach((to, from, next) => {
  const requireAuth = to?.meta.auth;
  const user = JSON.parse(localStorage.getItem("user"));
  const userRoles = user?.roles?.map(r => r.name) || ['guest'];

  store.commit('closeSidebar');

  if (store.getters['auth/isAuthenticated'] && to?.path === '/login') {
    next('/dashboard');
  } else if (requireAuth && store.getters['auth/isAuthenticated']) {
    const allowedRoles = to?.meta?.roles || [];
    console.info(allowedRoles)
    console.info(userRoles)
    const hasAccess = userRoles.some(r => allowedRoles.some(role => role === r))

    if (hasAccess) {
      next();
    } else {
      toast.warning('Sizga bu sahifa ga kirish ruhsati berilmagan!');
      next('/profile');
    }
  } else if (requireAuth && !store.getters['auth/isAuthenticated']) {
    next('/login');
  } else {
    next();
  }
});





export default router;
